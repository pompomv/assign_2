name: CI/CD Auto Pull and Rebuild

on:
  push:
    branches: [ pompom ]      # Jalan otomatis saat ada push ke main
  workflow_dispatch:         # Bisa dijalankan manual dari tab Actions

jobs:
  # =========================================
  # DEPLOY KE LAPTOP POMPOM
  # =========================================
  deploy-pompom:
    runs-on: [self-hosted, Pompom_1]

    steps:
      # Step 0: Set path project secara eksplisit
      - name: Set project path
        shell: bash
        run: |
          echo "PROJECT_PATH=/home/pompom/assign_2" >> "$GITHUB_ENV"
          echo "✅ PROJECT_PATH set to /home/pompom/assign_2"

      # (Opsional) Debug: pastikan folder adalah repo Git dan bisa diakses
      - name: Debug repo and Docker
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          echo "=== DEBUG INFO (POMPOM) ==="
          pwd
          ls -a
          echo
          echo "=== GIT STATUS ==="
          git status
          echo
          echo "=== GIT REMOTE ==="
          git remote -v || true
          echo
          echo "=== DOCKER COMPOSE VERSION ==="
          docker compose version

      # Step 1: Ambil kode terbaru dari branch main
      - name: Pull latest changes
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          git fetch origin main           # Download update terbaru
          git reset --hard origin/main   # Reset ke versi terbaru (hapus perubahan lokal)

      # Step 2: Stop semua container yang sedang berjalan
      - name: Stop existing containers
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          docker compose down || true    # Lanjut walau ada error

      # Step 3: Bersihkan resource lama (opsional, hemat storage)
      - name: Remove old images and unused resources
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          docker system prune -f
          docker image prune -a -f

      # Step 4: Build ulang dan jalankan semua container
      - name: Build and start containers
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          docker compose build --no-cache
          docker compose up -d

      # Step 5: Tunggu sampai service siap
      - name: Wait for services to be ready
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          sleep 30
          docker compose ps

      # Step 6: Health check aplikasi
      - name: Health check
        shell: bash
        run: |
          curl -f http://localhost:8081 || exit 1

      # Step 7: Notifikasi status deployment
      - name: Notify deployment status
        if: always()
        shell: bash
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deployment berhasil di laptop Pompom! Aplikasi sudah update ke versi terbaru."
          else
            echo "❌ Deployment gagal di laptop Pompom! Cek log error di atas."
          fi

  # =========================================
  # DEPLOY KE LAPTOP FALAH
  # =========================================
  deploy-falah:
    runs-on: [self-hosted, Falah_1]

    steps:
      # Step 0: Set path project secara eksplisit (SESUIKAN username)
      - name: Set project path
        shell: bash
        run: |
          echo "PROJECT_PATH=/home/falah/assign_2" >> "$GITHUB_ENV"
          echo "✅ PROJECT_PATH set to /home/falah/assign_2"

      # Debug: pastikan folder benar
      - name: Debug repo and Docker
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          echo "=== DEBUG INFO (FALAH) ==="
          pwd
          ls -a
          echo
          echo "=== GIT STATUS ==="
          git status
          echo
          echo "=== GIT REMOTE ==="
          git remote -v || true
          echo
          echo "=== DOCKER COMPOSE VERSION ==="
          docker compose version

      # Step 1: Ambil kode terbaru dari branch main
      - name: Pull latest changes
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          git fetch origin main
          git reset --hard origin/main

      # Step 2: Stop semua container yang sedang berjalan
      - name: Stop existing containers
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          docker compose down || true

      # Step 3: Bersihkan resource lama
      - name: Remove old images and unused resources
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          docker system prune -f
          docker image prune -a -f

      # Step 4: Build ulang dan jalankan semua container
      - name: Build and start containers
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          docker compose build --no-cache
          docker compose up -d

      # Step 5: Tunggu sampai service siap
      - name: Wait for services to be ready
        shell: bash
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          sleep 30
          docker compose ps

      # Step 6: Health check aplikasi
      - name: Health check
        shell: bash
        run: |
          curl -f http://localhost:8081 || exit 1

      # Step 7: Notifikasi status deployment
      - name: Notify deployment status
        if: always()
        shell: bash
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deployment berhasil di laptop Falah! Aplikasi sudah update ke versi terbaru."
          else
            echo "❌ Deployment gagal di laptop Falah! Cek log error di atas."
          fi

